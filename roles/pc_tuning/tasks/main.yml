

---
- name: Ensure sysctl.d directory exists
  ansible.builtin.file:
    path: /etc/sysctl.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: [pc_tuning, sysctl]

- name: Load BBR kernel module
  community.general.modprobe:
    name: tcp_bbr
    state: present
  failed_when: false
  tags: [pc_tuning, sysctl]

- name: Apply system tuning via sysctl
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: true
  loop: "{{ workstation_sysctl_settings }}"
  tags: [pc_tuning, sysctl]

- name: Persist workstation sysctl settings
  ansible.builtin.lineinfile:
    path: /etc/sysctl.d/99-workstation-tuning.conf
    line: "{{ item.name }} = {{ item.value }}"
    regexp: "^#?{{ item.name }}"
    state: present
    create: true
    owner: root
    group: root
    mode: '0644'
  loop: "{{ workstation_sysctl_settings }}"
  tags: [pc_tuning, sysctl]

- name: Set limits for user sessions
  ansible.builtin.copy:
    dest: /etc/security/limits.d/99-workstation.conf
    content: |
      * soft nofile {{ user_nofile }}
      * hard nofile {{ user_nofile }}
      * soft nproc 65535
      * hard nproc 65535
      * soft memlock unlimited
      * hard memlock unlimited
    owner: root
    group: root
    mode: '0644'
  tags: [pc_tuning, limits]
