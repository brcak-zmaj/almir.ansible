---
# =============================================================================
# NUT (Network UPS Tools) Role - Main Tasks
# =============================================================================

# Determine effective role mode
- name: Set effective role mode
  ansible.builtin.set_fact:
    _nut_role_mode: "{{ nut_role_mode | default('server') }}"
  tags:
    - nut
    - nut-config

# =============================================================================
# CLIENT MODE - Minimal installation for remote monitoring
# =============================================================================
- name: Include client mode tasks
  ansible.builtin.include_tasks: client.yml
  when: _nut_role_mode == 'client'
  tags:
    - nut
    - nut-client

# =============================================================================
# SERVER MODE - Full NUT server installation
# =============================================================================
- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_facts['distribution'] }}-{{ ansible_facts['distribution_major_version'] }}.yml"
        - "{{ ansible_facts['distribution'] }}.yml"
        - "{{ ansible_facts['os_family'] }}.yml"
        - "default.yml"
      paths:
        - "{{ role_path }}/vars"
      skip: true
  when: _nut_role_mode == 'server'
  tags:
    - nut
    - nut-config

# Apply OS-specific defaults while respecting user overrides
# User-defined values in playbook vars take precedence over these defaults
- name: Set OS-specific service names (respecting user overrides)
  ansible.builtin.set_fact:
    nut_driver_service: "{{ nut_driver_service | default(_nut_driver_service_default | default('nut-driver')) }}"
    nut_server_service: "{{ nut_server_service | default(_nut_server_service_default | default('nut-server')) }}"
    nut_monitor_service: "{{ nut_monitor_service | default(_nut_monitor_service_default | default('nut-monitor')) }}"
  when: _nut_role_mode == 'server'
  tags:
    - nut
    - nut-config

- name: Include installation tasks
  ansible.builtin.include_tasks: install.yml
  when:
    - _nut_role_mode == 'server'
    - nut_install_enabled | bool
  tags:
    - nut
    - nut-install

- name: Include configuration tasks
  ansible.builtin.include_tasks: configure.yml
  when:
    - _nut_role_mode == 'server'
    - nut_install_enabled | bool
  tags:
    - nut
    - nut-config

- name: Include service tasks
  ansible.builtin.include_tasks: service.yml
  when:
    - _nut_role_mode == 'server'
    - nut_install_enabled | bool
  tags:
    - nut
    - nut-service

- name: Include UPS settings tasks
  ansible.builtin.include_tasks: ups_settings.yml
  when:
    - _nut_role_mode == 'server'
    - nut_install_enabled | bool
    - nut_ups_settings_enabled | bool
  tags:
    - nut
    - nut-ups-settings

- name: Include exporter tasks
  ansible.builtin.include_tasks: exporter.yml
  when: _nut_role_mode == 'server'
  tags:
    - nut
    - nut-exporter
