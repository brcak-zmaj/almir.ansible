---
# =============================================================================
# NUT Installation Tasks
# =============================================================================

- name: Install NUT packages (RedHat)
  ansible.builtin.dnf:
    name: "{{ nut_packages_redhat }}"
    state: present
  when: ansible_facts['os_family'] == 'RedHat'
  tags:
    - nut
    - nut-install

- name: Install NUT packages (Debian)
  ansible.builtin.apt:
    name: "{{ nut_packages_debian }}"
    state: present
    update_cache: true
  when: ansible_facts['os_family'] == 'Debian'
  tags:
    - nut
    - nut-install

- name: Install optional NUT scanner libraries (Debian)
  ansible.builtin.apt:
    name: "{{ _nut_optional_packages_debian | default([]) }}"
    state: present
  when:
    - ansible_facts['os_family'] == 'Debian'
    - nut_install_scanner_libs | default(true) | bool
  tags:
    - nut
    - nut-install

- name: Install optional NUT scanner libraries (RedHat)
  ansible.builtin.dnf:
    name: "{{ _nut_optional_packages_redhat | default([]) }}"
    state: present
  when:
    - ansible_facts['os_family'] == 'RedHat'
    - nut_install_scanner_libs | default(true) | bool
  tags:
    - nut
    - nut-install

- name: Ensure NUT group exists
  ansible.builtin.group:
    name: nut
    system: true
    state: present
  tags:
    - nut
    - nut-install

- name: Ensure NUT user exists
  ansible.builtin.user:
    name: nut
    group: nut
    system: true
    shell: /sbin/nologin
    home: "{{ nut_state_dir }}"
    create_home: false
  tags:
    - nut
    - nut-install

- name: Ensure NUT directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ nut_config_owner }}"
    group: "{{ nut_config_group }}"
    mode: "{{ nut_config_dir_mode }}"
  loop:
    - "{{ nut_config_dir }}"
    - "{{ nut_state_dir }}"
  tags:
    - nut
    - nut-install

- name: Ensure NUT run directory exists
  ansible.builtin.file:
    path: "{{ nut_run_dir }}"
    state: directory
    owner: nut
    group: nut
    mode: "0755"
  tags:
    - nut
    - nut-install

- name: Deploy udev rules for USB UPS devices
  ansible.builtin.template:
    src: 99-nut-ups.rules.j2
    dest: /etc/udev/rules.d/99-nut-ups.rules
    owner: root
    group: root
    mode: "0644"
  when: nut_udev_rules_enabled | bool
  notify:
    - Reload udev rules
  tags:
    - nut
    - nut-install

# Flush handlers to ensure udev rules are applied before services start
# This is critical because the NUT driver needs USB device permissions
- name: Flush handlers to apply udev rules immediately
  ansible.builtin.meta: flush_handlers
  when: nut_udev_rules_enabled | bool
  tags:
    - nut
    - nut-install
