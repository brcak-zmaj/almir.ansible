---
# =============================================================================
# NUT Exporter Installation Tasks
# =============================================================================
# Installs nut_exporter for Prometheus metrics from NUT
# https://github.com/DRuggeri/nut_exporter
#
# Supports two installation methods:
#   - Binary (default): Downloads from GitHub releases
#   - Docker: Runs as a container

# =============================================================================
# VERSION RESOLUTION
# =============================================================================
- name: Get latest nut_exporter version from GitHub
  when:
    - nut_exporter_enabled | bool
    - nut_exporter_version == "latest"
  block:
    - name: Query GitHub API for latest release
      ansible.builtin.uri:
        url: https://api.github.com/repos/DRuggeri/nut_exporter/releases/latest
        return_content: true
        headers:
          Accept: application/vnd.github.v3+json
      register: _nut_exporter_github_release
      changed_when: false

    - name: Set resolved version from GitHub
      ansible.builtin.set_fact:
        _nut_exporter_resolved_version: "{{ _nut_exporter_github_release.json.tag_name | regex_replace('^v', '') }}"

- name: Set version for non-latest
  ansible.builtin.set_fact:
    _nut_exporter_resolved_version: "{{ nut_exporter_version | regex_replace('^v', '') }}"
  when:
    - nut_exporter_enabled | bool
    - nut_exporter_version != "latest"

# =============================================================================
# BINARY INSTALLATION
# =============================================================================
- name: Install nut_exporter binary
  when:
    - nut_exporter_enabled | bool
    - nut_exporter_install_method == "binary"
  block:
    - name: Set architecture mapping
      ansible.builtin.set_fact:
        _nut_exporter_arch_map:
          x86_64: "amd64"
          aarch64: "arm64"
          armv7l: "arm"
          armv6l: "arm"
          i386: "386"
          i686: "386"

    - name: Determine binary architecture
      ansible.builtin.set_fact:
        _nut_exporter_arch: "{{ _nut_exporter_arch_map[ansible_facts['architecture']] | default('amd64') }}"

    - name: Determine binary OS
      ansible.builtin.set_fact:
        _nut_exporter_os: "{{ 'linux' if ansible_facts['system'] == 'Linux' else ansible_facts['system'] | lower }}"

    - name: Construct download URL
      ansible.builtin.set_fact:
        _nut_exporter_download_url: "https://github.com/DRuggeri/nut_exporter/releases/download/v{{ _nut_exporter_resolved_version }}/nut_exporter-v{{ _nut_exporter_resolved_version }}-{{ _nut_exporter_os }}-{{ _nut_exporter_arch }}"

    - name: Ensure nut_exporter directory exists
      ansible.builtin.file:
        path: "{{ nut_exporter_install_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Check if nut_exporter binary exists
      ansible.builtin.stat:
        path: "{{ nut_exporter_install_dir }}/nut_exporter"
      register: _nut_exporter_binary

    - name: Check current nut_exporter version
      ansible.builtin.command: "{{ nut_exporter_install_dir }}/nut_exporter --version"
      register: _nut_exporter_current_version
      changed_when: false
      failed_when: false
      when: _nut_exporter_binary.stat.exists

    - name: Download nut_exporter binary
      ansible.builtin.get_url:
        url: "{{ _nut_exporter_download_url }}"
        dest: "{{ nut_exporter_install_dir }}/nut_exporter"
        owner: root
        group: root
        mode: "0755"
        force: true
      when: >-
        not _nut_exporter_binary.stat.exists or
        (_nut_exporter_current_version.stdout is defined and
         _nut_exporter_resolved_version not in (_nut_exporter_current_version.stdout | default('')))
      notify: Restart nut_exporter

    - name: Deploy nut_exporter systemd service
      ansible.builtin.template:
        src: nut_exporter.service.j2
        dest: /etc/systemd/system/nut_exporter.service
        owner: root
        group: root
        mode: "0644"
      notify:
        - Reload systemd
        - Restart nut_exporter

    - name: Enable and start nut_exporter service
      ansible.builtin.systemd:
        name: nut_exporter
        enabled: "{{ nut_exporter_service_enabled | bool }}"
        state: "{{ 'started' if nut_exporter_service_started | bool else 'stopped' }}"
        daemon_reload: true

# =============================================================================
# DOCKER INSTALLATION
# =============================================================================
- name: Install nut_exporter via Docker
  when:
    - nut_exporter_enabled | bool
    - nut_exporter_install_method == "docker"
  block:
    - name: Create nut_exporter container
      community.docker.docker_container:
        name: "{{ nut_exporter_container_name }}"
        image: "druggeri/nut_exporter:{{ _nut_exporter_resolved_version }}"
        pull: true
        state: started
        restart_policy: unless-stopped
        memory: "{{ nut_exporter_docker_memory }}"
        cpus: "{{ nut_exporter_docker_cpus }}"
        ports:
          - "{{ nut_exporter_port }}:9199"
        env:
          NUT_EXPORTER_SERVER: "{{ nut_exporter_nut_server }}"
          NUT_EXPORTER_SERVERPORT: "{{ nut_exporter_nut_port | string }}"
          NUT_EXPORTER_USERNAME: "{{ nut_exporter_nut_username }}"
          NUT_EXPORTER_PASSWORD: "{{ nut_exporter_nut_password }}"
          NUT_EXPORTER_VARIABLES: "{{ nut_exporter_variables | join(',') if nut_exporter_variables else '' }}"
          TZ: "{{ nut_exporter_timezone }}"
        networks: "{{ nut_exporter_docker_networks | default(omit) }}"
        log_driver: "{{ nut_exporter_docker_log_driver | default(omit) }}"
        log_options: "{{ nut_exporter_docker_log_options | default(omit) }}"

# =============================================================================
# CLEANUP (when disabled)
# =============================================================================
- name: Remove nut_exporter when disabled
  when: not (nut_exporter_enabled | bool)
  block:
    - name: Stop and disable nut_exporter service
      ansible.builtin.systemd:
        name: nut_exporter
        enabled: false
        state: stopped
      failed_when: false

    - name: Remove nut_exporter systemd service file
      ansible.builtin.file:
        path: /etc/systemd/system/nut_exporter.service
        state: absent
      notify: Reload systemd

    - name: Remove nut_exporter container
      community.docker.docker_container:
        name: "{{ nut_exporter_container_name }}"
        state: absent
      failed_when: false
