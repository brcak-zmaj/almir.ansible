---
# Deploy VM and LXC configurations from files directory
# This task copies pre-backed-up VM/LXC configs to the target Proxmox server
# Use the backup_proxmox_configs.sh script first to backup configs from old server

- name: Ensure VM configs directory exists on target
  ansible.builtin.file:
    path: /etc/pve/qemu-server
    state: directory
    mode: "0755"

- name: Ensure LXC configs directory exists on target
  ansible.builtin.file:
    path: /etc/pve/lxc
    state: directory
    mode: "0755"

- name: Find VM configuration files
  ansible.builtin.find:
    paths: "{{ role_path }}/files/vm_configs"
    patterns: "*.conf"
    file_type: file
  register: vm_config_files
  when: pve_deploy_vm_configs | default(false)

- name: Display VM config deployment status
  ansible.builtin.debug:
    msg: "Found {{ vm_config_files.files | length | default(0) }} VM configuration(s) to deploy"
  when:
    - pve_deploy_vm_configs | default(false)
    - vm_config_files is defined

- name: Warn if no VM configs found
  ansible.builtin.debug:
    msg: "No VM configurations found in files/vm_configs/. Use backup_proxmox_configs.sh to backup configs first."
  when:
    - pve_deploy_vm_configs | default(false)
    - vm_config_files.files | length == 0

- name: Copy VM configurations to target server
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "/etc/pve/qemu-server/{{ item.path | basename }}"
    mode: "0640"
    owner: root
    group: www-data
    remote_src: false
  loop: "{{ vm_config_files.files | default([]) }}"
  when:
    - pve_deploy_vm_configs | default(false)
    - vm_config_files.files | length > 0
  no_log: false

- name: Find LXC configuration files
  ansible.builtin.find:
    paths: "{{ role_path }}/files/lxc_configs"
    patterns: "*.conf"
    file_type: file
  register: lxc_config_files
  when: pve_deploy_vm_configs | default(false)

- name: Display LXC config deployment status
  ansible.builtin.debug:
    msg: "Found {{ lxc_config_files.files | length | default(0) }} LXC configuration(s) to deploy"
  when:
    - pve_deploy_vm_configs | default(false)
    - lxc_config_files is defined

- name: Warn if no LXC configs found
  ansible.builtin.debug:
    msg: "No LXC configurations found in files/lxc_configs/. Use backup_proxmox_configs.sh to backup configs first."
  when:
    - pve_deploy_vm_configs | default(false)
    - lxc_config_files.files | length == 0

- name: Copy LXC configurations to target server
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "/etc/pve/lxc/{{ item.path | basename }}"
    mode: "0640"
    owner: root
    group: www-data
    remote_src: false
  loop: "{{ lxc_config_files.files | default([]) }}"
  when:
    - pve_deploy_vm_configs | default(false)
    - lxc_config_files.files | length > 0
  no_log: false

