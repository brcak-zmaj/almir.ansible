---
- name: Check if ZFS is available
  ansible.builtin.stat:
    path: /usr/sbin/zfs
  register: zfs_binary_check
  failed_when: false

- name: Check ZFS version (alternative check)
  ansible.builtin.command: /usr/sbin/zfs version
  register: zfs_version_check
  changed_when: false
  failed_when: false
  when: zfs_binary_check.stat.exists

- name: Set ZFS availability fact
  ansible.builtin.set_fact:
    zfs_available: "{{ zfs_binary_check.stat.exists or (zfs_version_check.rc | default(1) == 0) }}"

- name: Display ZFS availability status
  ansible.builtin.debug:
    msg: "ZFS is {{ 'available' if zfs_available else 'not available' }}. ZFS tuning tasks will be {{ 'executed' if zfs_available else 'skipped' }}."
  when: not zfs_available

- name: Update ZFS snapshots cron jobs
  ansible.builtin.cron:
    name: "Adjust {{ item.name }}"
    minute: "{{ item.minute }}"
    hour: "{{ item.hour }}"
    day: "{{ item.day }}"
    job: "/usr/bin/sed -i 's|--keep=[0-9]*|--keep={{ item.keep }}|g' {{ item.file }}"
  loop:
    - { name: 'zfs-auto-snapshot daily', minute: '0', hour: '0', day: '*', keep: '3', file: '/etc/cron.daily/zfs-auto-snapshot' }
    - { name: 'zfs-auto-snapshot weekly', minute: '0', hour: '0', day: '7', keep: '3', file: '/etc/cron.weekly/zfs-auto-snapshot' }
    - { name: 'zfs-auto-snapshot monthly', minute: '0', hour: '0', day: '1', keep: '3', file: '/etc/cron.monthly/zfs-auto-snapshot' }
  when: zfs_available | default(false)

- name: Calculate RAM size in GB from gathered facts for ZFS
  ansible.builtin.set_fact:
    ram_size_gb: "{{ (ansible_memtotal_mb | int / 1024) | int }}"
  when: zfs_available | default(false)

- name: Calculate ZFS ARC min value based on RAM size
  ansible.builtin.set_fact:
    zfs_arc_min: "{{ 536870911 }}"
  when: 
    - zfs_check.rc == 0
    - ram_size_gb | int <= 16

- name: Calculate ZFS ARC min value for 16-32GB RAM
  ansible.builtin.set_fact:
    zfs_arc_min: "{{ 1073741823 }}"
  when: 
    - zfs_check.rc == 0
    - ram_size_gb | int > 16
    - ram_size_gb | int <= 32

- name: Calculate ZFS ARC min value for >32GB RAM
  ansible.builtin.set_fact:
    calculated_arc_min: "{{ (ram_size_gb | int * 1073741824 / 16) | int }}"
  when: 
    - zfs_check.rc == 0
    - ram_size_gb | int > 32

- name: Set ZFS ARC min value for >32GB RAM (enforce minimum)
  ansible.builtin.set_fact:
    zfs_arc_min: "{{ (calculated_arc_min | int >= 536870911) | ternary(calculated_arc_min | int, 536870911) }}"
  when: 
    - zfs_check.rc == 0
    - ram_size_gb | int > 32
    - calculated_arc_min is defined

- name: Calculate ZFS ARC max value based on RAM size
  ansible.builtin.set_fact:
    zfs_arc_max: "{{ 536870912 }}"
  when: 
    - zfs_check.rc == 0
    - ram_size_gb | int <= 16

- name: Calculate ZFS ARC max value for 16-32GB RAM
  ansible.builtin.set_fact:
    zfs_arc_max: "{{ 1073741824 }}"
  when: 
    - zfs_check.rc == 0
    - ram_size_gb | int > 16
    - ram_size_gb | int <= 32

- name: Calculate ZFS ARC max value for >32GB RAM
  ansible.builtin.set_fact:
    calculated_arc_max: "{{ (ram_size_gb | int * 1073741824 / 8) | int }}"
  when: 
    - zfs_check.rc == 0
    - ram_size_gb | int > 32

- name: Set ZFS ARC max value for >32GB RAM (enforce minimum)
  ansible.builtin.set_fact:
    zfs_arc_max: "{{ (calculated_arc_max | int >= 536870912) | ternary(calculated_arc_max | int, 536870912) }}"
  when: 
    - zfs_check.rc == 0
    - ram_size_gb | int > 32
    - calculated_arc_max is defined

- name: Create ZFS ARC modprobe configuration
  ansible.builtin.template:
    src: 99-xs-zfsarc.conf.j2
    dest: /etc/modprobe.d/99-xs-zfsarc.conf
    owner: root
    group: root
    mode: "0644"
  when: zfs_available | default(false)
  register: zfs_arc_config
  notify:
    - update initramfs

- name: Verify ZFS ARC config will be in initramfs (fix boot warning)
  ansible.builtin.shell: |
    # The handler will update initramfs, but we verify the config is correct
    # The warning appears because ZFS loads early, but the config is applied correctly
    # After reboot, the warning should disappear as initramfs includes the config
    if [ -f /etc/modprobe.d/99-xs-zfsarc.conf ]; then
      echo "ZFS ARC config present, will be included in initramfs on next update"
    fi
  when: 
    - zfs_check.rc == 0
    - zfs_arc_config.changed | default(false)
  changed_when: false
  failed_when: false

- name: Configure ZFS scrub schedule
  ansible.builtin.cron:
    name: "ZFS scrub (second Sunday of month)"
    minute: "{{ pve_zfs_scrub_minute }}"
    hour: "{{ pve_zfs_scrub_hour }}"
    day: "{{ pve_zfs_scrub_day_start }}-{{ pve_zfs_scrub_day_end }}"
    month: "*"
    weekday: "0"
    job: "if [ $(date +\\%w) -eq 0 ] && [ -x /usr/lib/zfs-linux/scrub ]; then /usr/lib/zfs-linux/scrub; fi"
    state: "{{ 'present' if pve_zfs_scrub_enable | default(true) else 'absent' }}"
  when: zfs_available | default(false)

- name: Display ZFS ARC configuration result
  ansible.builtin.debug:
    msg: "ZFS ARC tuning completed. RAM detected: {{ ram_size_gb }}GB"
  when: zfs_available | default(false)

