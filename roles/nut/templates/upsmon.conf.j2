# {{ ansible_managed }}
# =============================================================================
# UPSMON Configuration File - /etc/nut/upsmon.conf
# =============================================================================
#
# UPS monitoring daemon configuration.
# Controls how upsmon watches UPS devices and responds to power events.
#

# =============================================================================
# MONITOR CONFIGURATION
# =============================================================================
# Format: MONITOR <system> <powervalue> <username> <password> <type>
# <system>     = <upsname>@<hostname>[:<port>]
# <powervalue> = Number of power supplies this UPS feeds to this system
# <type>       = "primary" (can command shutdown) or "secondary" (monitor only)
#
{% for monitor in nut_upsmon_monitors %}
MONITOR {{ monitor.ups }} {{ monitor.powervalue }} {{ monitor.username }} {{ monitor.password }} {{ monitor.type }}
{% endfor %}

# =============================================================================
# SYSTEM SETTINGS
# =============================================================================

# Minimum power supplies required to keep running
MINSUPPLIES {{ nut_upsmon_minsupplies }}

# Command to run when shutting down
SHUTDOWNCMD "{{ nut_upsmon_shutdowncmd }}"

{% if nut_upsmon_notifycmd | length > 0 %}
# Notification command for external scripts
NOTIFYCMD "{{ nut_upsmon_notifycmd }}"
{% endif %}

# Polling interval in seconds (normal)
POLLFREQ {{ nut_upsmon_pollfreq }}

# Polling interval in seconds (when on battery)
POLLFREQALERT {{ nut_upsmon_pollfreqalert }}

# Seconds before declaring a UPS "dead"
DEADTIME {{ nut_upsmon_deadtime }}

# Seconds for secondary systems to wait for primary to set FSD
HOSTSYNC {{ nut_upsmon_hostsync }}

# Final delay before shutdown (seconds)
FINALDELAY {{ nut_upsmon_finaldelay }}

# Flag file indicating power should be cut
POWERDOWNFLAG {{ nut_upsmon_powerdownflag }}

# =============================================================================
# NOTIFICATION FLAGS
# =============================================================================
# Flags: SYSLOG, WALL, EXEC, IGNORE
#
{% for event, flags in nut_upsmon_notify_flags.items() %}
NOTIFYFLAG {{ event | upper }} {{ flags }}
{% endfor %}

# =============================================================================
# NOTIFICATION MESSAGES
# =============================================================================
{% for event, message in nut_upsmon_notify_messages.items() %}
NOTIFYMSG {{ event | upper }} "{{ message }}"
{% endfor %}

# Run upsmon in the foreground (required for systemd)
RUN_AS_USER nut
