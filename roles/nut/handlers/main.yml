---
# =============================================================================
# NUT Handlers
# =============================================================================

- name: Reload udev rules
  ansible.builtin.command: udevadm control --reload-rules
  changed_when: true
  listen: Reload udev rules

- name: Trigger udev rules
  ansible.builtin.command: udevadm trigger
  changed_when: true
  listen: Reload udev rules

- name: Restart NUT driver
  ansible.builtin.systemd:
    name: "{{ nut_driver_service }}"
    state: restarted
    daemon_reload: true
  when: nut_mode in ['standalone', 'netserver']

- name: Restart NUT server
  ansible.builtin.systemd:
    name: "{{ nut_server_service }}"
    state: restarted
    daemon_reload: true
  when: nut_mode in ['standalone', 'netserver']

- name: Restart NUT monitor
  ansible.builtin.systemd:
    name: "{{ nut_monitor_service | default('nut-client') }}"
    state: restarted
    daemon_reload: true
  when: nut_mode != 'none' or _nut_role_mode | default('server') == 'client'

- name: Reload NUT driver
  ansible.builtin.systemd:
    name: "{{ nut_driver_service }}"
    state: reloaded
  when: nut_mode in ['standalone', 'netserver']

- name: Reload NUT server
  ansible.builtin.systemd:
    name: "{{ nut_server_service }}"
    state: reloaded
  when: nut_mode in ['standalone', 'netserver']

# =============================================================================
# NUT Exporter Handlers
# =============================================================================
- name: Reload systemd
  ansible.builtin.systemd:
    daemon_reload: true

- name: Restart nut_exporter
  ansible.builtin.systemd:
    name: nut_exporter
    state: restarted
    daemon_reload: true
  when:
    - nut_exporter_enabled | default(false) | bool
    - nut_exporter_install_method | default('binary') == 'binary'
