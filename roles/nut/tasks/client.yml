---
# =============================================================================
# NUT Client Mode Tasks
# =============================================================================
# This file configures a system as a NUT client (netclient mode).
# The client monitors a remote NUT server and shuts down when the UPS
# battery becomes critical.
#
# USAGE:
#   Set nut_role_mode: "client" in your playbook vars
#   Configure nut_server_host, nut_client_username, nut_client_password
#
# SHUTDOWN ORDERING:
#   Use nut_client_shutdown_delay (FINALDELAY) to control shutdown order:
#   - Lower values = shutdown first
#   - Higher values = shutdown later
#   Example: Proxmox(0) → TrueNAS(60) → pfSense(90) → NUT Server(120)
# =============================================================================

- name: Validate client mode requirements
  ansible.builtin.assert:
    that:
      - nut_server_host is defined and nut_server_host | length > 0
      - nut_client_password is defined and nut_client_password | length > 0
    fail_msg: >-
      Client mode requires nut_server_host and nut_client_password to be defined.
      Set these in your playbook vars.
    success_msg: "Client mode requirements validated"
  tags:
    - nut
    - nut-client

- name: Display client mode configuration
  ansible.builtin.debug:
    msg: |
      NUT Client Mode Configuration:
        Server: {{ nut_server_host }}:{{ nut_server_port }}
        UPS: {{ nut_client_ups_name }}
        User: {{ nut_client_username }}
        Shutdown Order: {{ nut_client_shutdown_order | default('Not specified') }}
        Shutdown Delay: {{ nut_client_shutdown_delay }} seconds
  tags:
    - nut
    - nut-client

# =============================================================================
# PACKAGE INSTALLATION
# =============================================================================
- name: Install NUT client packages (Debian)
  ansible.builtin.apt:
    name: "{{ nut_client_packages_debian }}"
    state: present
    update_cache: true
  when: ansible_facts['os_family'] == 'Debian'
  tags:
    - nut
    - nut-client

- name: Install NUT client packages (RedHat)
  ansible.builtin.dnf:
    name: "{{ nut_client_packages_redhat }}"
    state: present
  when: ansible_facts['os_family'] == 'RedHat'
  tags:
    - nut
    - nut-client

# =============================================================================
# DIRECTORY SETUP
# =============================================================================
- name: Ensure NUT configuration directory exists
  ansible.builtin.file:
    path: "{{ nut_config_dir }}"
    state: directory
    owner: root
    group: nut
    mode: "0755"
  tags:
    - nut
    - nut-client

# =============================================================================
# CONFIGURATION FILES
# =============================================================================
- name: Configure NUT mode (netclient)
  ansible.builtin.template:
    src: nut.conf.client.j2
    dest: "{{ nut_config_dir }}/nut.conf"
    owner: root
    group: nut
    mode: "0644"
  notify: Restart NUT monitor
  tags:
    - nut
    - nut-client

- name: Configure upsmon for client mode
  ansible.builtin.template:
    src: upsmon.conf.client.j2
    dest: "{{ nut_config_dir }}/upsmon.conf"
    owner: root
    group: nut
    mode: "0600"
  notify: Restart NUT monitor
  tags:
    - nut
    - nut-client

# =============================================================================
# SERVICE MANAGEMENT
# =============================================================================
- name: Ensure nut-client service is enabled and started
  ansible.builtin.systemd:
    name: nut-client
    enabled: true
    state: started
  tags:
    - nut
    - nut-client

# =============================================================================
# VERIFICATION
# =============================================================================
- name: Test connection to NUT server
  ansible.builtin.command:
    cmd: >-
      upsc {{ nut_client_ups_name }}@{{ nut_server_host }}:{{ nut_server_port }}
      ups.status
  register: _nut_client_test
  changed_when: false
  failed_when: false
  tags:
    - nut
    - nut-client

- name: Display NUT server connection status
  ansible.builtin.debug:
    msg: |
      {% if _nut_client_test.rc == 0 %}
      ✓ Successfully connected to {{ nut_client_ups_name }}@{{ nut_server_host }}
        UPS Status: {{ _nut_client_test.stdout | default('Unknown') }}
      {% else %}
      ✗ Failed to connect to {{ nut_client_ups_name }}@{{ nut_server_host }}
        Error: {{ _nut_client_test.stderr | default('Unknown error') }}
        
        Troubleshooting:
        1. Verify NUT server is running: upsc {{ nut_client_ups_name }}@{{ nut_server_host }}
        2. Check firewall allows port {{ nut_server_port }}/tcp
        3. Verify user '{{ nut_client_username }}' exists in server's upsd.users
        4. Check server's upsd.conf has LISTEN for this client's network
      {% endif %}
  tags:
    - nut
    - nut-client
