---
# =============================================================================
# Apply UPS Settings to a Single UPS Device
# =============================================================================
# Called by ups_settings.yml for each UPS in the list
# Uses _current_ups variable for the UPS name
# =============================================================================

- name: "Detect UPS make and model [{{ _current_ups }}]"
  ansible.builtin.command:
    cmd: "upsc {{ _current_ups }}@localhost device.mfr device.model"
  register: _nut_ups_info
  changed_when: false
  failed_when: false

- name: "Display detected UPS [{{ _current_ups }}]"
  ansible.builtin.debug:
    msg: "{{ _current_ups }}: {{ _nut_ups_info.stdout_lines | default(['Unknown']) | join(' ') }}"
  when: _nut_ups_info.rc == 0

- name: "Apply settings to UPS [{{ _current_ups }}]"
  ansible.builtin.command:
    cmd: >-
      upsrw -s {{ item.variable }}={{ item.value }}
      -u {{ nut_ups_admin_username }}
      -p {{ nut_ups_admin_password }}
      {{ _current_ups }}@localhost
  loop: "{{ nut_ups_settings }}"
  loop_control:
    label: "{{ _current_ups }}: {{ item.variable }}={{ item.value }}"
  register: _nut_setting_result
  changed_when: "'OK' in _nut_setting_result.stdout"
  failed_when: "'ERR' in _nut_setting_result.stdout"
  no_log: "{{ nut_ups_settings_no_log }}"
  when: nut_ups_settings | length > 0
